@startuml Sequence - Tạo yêu cầu chat hỗ trợ

skinparam participantPadding 20
skinparam boxPadding 10

actor "Người dùng" as User
participant "Chat Management UI" as ChatUI
participant "Create Request Dialog" as CreateDialog
participant "Chat API" as ChatAPI
participant "API Server" as API
participant "Database" as DB
participant "Socket Manager" as SocketMgr
participant "Notification Service" as NotifSvc

User -> ChatUI: Truy cập /chat
activate ChatUI

ChatUI -> ChatAPI: getChatRequests({direction: "all"})
activate ChatAPI

ChatAPI -> API: GET /chat/requests
activate API

API -> DB: Find user's chat requests
activate DB
DB -> API: requests[]
deactivate DB

API -> ChatAPI: requests data
deactivate API

ChatAPI -> ChatUI: transformed requests
deactivate ChatAPI

ChatUI -> User: Hiển thị tab "requests"\n(existing requests list)

User -> ChatUI: Click "Tạo yêu cầu mới"

ChatUI -> CreateDialog: Open CreateChatRequestDialog
activate CreateDialog
deactivate ChatUI

CreateDialog -> User: Hiển thị form:\n- Người nhận (dropdown)\n- Tiêu đề (text input)\n- Nội dung (textarea)

User -> CreateDialog: Chọn người nhận (optional)
User -> CreateDialog: Nhập tiêu đề yêu cầu
User -> CreateDialog: Nhập nội dung chi tiết
User -> CreateDialog: Click "Gửi yêu cầu"

CreateDialog -> CreateDialog: Validate form:\n- Tiêu đề không trống\n- Nội dung có ý nghĩa

alt Validation thành công
    CreateDialog -> ChatAPI: createChatRequest(requestData)
    activate ChatAPI
    
    ChatAPI -> API: POST /chat/requests\n{toUserId?, subject, message}
    activate API
    
    API -> DB: Create ChatRequest record
    activate DB
    DB -> API: created request
    deactivate DB
    
    alt Có người nhận cụ thể
        API -> NotifSvc: Notify specific user
        activate NotifSvc
        NotifSvc -> NotifSvc: createNotification(toUser)
        deactivate NotifSvc
        
        API -> SocketMgr: Emit real-time notification
        activate SocketMgr
        SocketMgr -> SocketMgr: socket.to(toUserId).emit("chat-request")
        deactivate SocketMgr
        
    else Không chỉ định người nhận
        API -> NotifSvc: Notify appropriate role
        activate NotifSvc
        NotifSvc -> NotifSvc: createNotification(roleUsers)
        deactivate NotifSvc
        
        API -> SocketMgr: Emit to role group
        activate SocketMgr
        SocketMgr -> SocketMgr: socket.to(roleRoom).emit("chat-request")
        deactivate SocketMgr
    end
    
    API -> ChatAPI: {success: true, request}
    deactivate API
    
    ChatAPI -> CreateDialog: success
    deactivate ChatAPI
    
    CreateDialog -> ChatUI: Close dialog + refresh
    activate ChatUI
    deactivate CreateDialog
    
    ChatUI -> ChatAPI: Reload requests
    activate ChatAPI
    ChatAPI -> ChatUI: updated requests
    deactivate ChatAPI
    
    ChatUI -> User: Toast "Gửi yêu cầu thành công!"
    ChatUI -> User: Hiển thị yêu cầu mới trong danh sách
    deactivate ChatUI
    
else Validation thất bại
    CreateDialog -> User: Hiển thị lỗi validation
    deactivate CreateDialog
end

note over User, NotifSvc
Người nhận sẽ nhận được thông báo real-time
và có thể chấp nhận/từ chối yêu cầu
end note

@enduml