@startuml Sequence - BCN duyệt điểm thực tập

skinparam participantPadding 20
skinparam boxPadding 10

actor "Ban Chủ Nhiệm" as BCN
participant "Grade Review UI" as ReviewUI
participant "Grade Detail UI" as DetailUI
participant "Grade API" as GradeAPI
participant "API Server" as API
participant "Database" as DB
participant "Notification Service" as NotifSvc

BCN -> ReviewUI: Truy cập /grade-review
activate ReviewUI

ReviewUI -> GradeAPI: getBCNSubmittedGrades()
activate GradeAPI

GradeAPI -> API: GET /grades/bcn/submitted
activate API

API -> DB: Find submitted grades by BCN subjects
activate DB
DB -> API: grades[] with student/supervisor info
deactivate DB

API -> GradeAPI: {grades: []}
deactivate API

GradeAPI -> ReviewUI: grades data
deactivate GradeAPI

ReviewUI -> BCN: Hiển thị danh sách điểm cần duyệt\n(search, status filter, pagination)

BCN -> ReviewUI: Search/filter điểm
ReviewUI -> ReviewUI: Filter by search term + status

BCN -> ReviewUI: Click "Duyệt" trên một điểm

ReviewUI -> DetailUI: Navigate to /grade-review/{gradeId}
activate DetailUI
deactivate ReviewUI

DetailUI -> GradeAPI: getGradeForReview(gradeId)
activate GradeAPI

GradeAPI -> API: GET /grades/bcn/{gradeId}/review
activate API

API -> DB: Find grade details for BCN review
activate DB
DB -> API: detailed grade with all components
deactivate DB

API -> GradeAPI: grade details
deactivate API

GradeAPI -> DetailUI: grade data
deactivate GradeAPI

DetailUI -> BCN: Hiển thị chi tiết điểm:\n- Student info\n- Grade components\n- Supervisor comments\n- Final grade\n- Review form (approve/reject)

BCN -> DetailUI: Xem xét điểm và nhận xét

alt Quyết định phê duyệt
    BCN -> DetailUI: Click "Phê duyệt"
    BCN -> DetailUI: Nhập ghi chú bổ sung (optional)
    BCN -> DetailUI: Confirm approval
    
    DetailUI -> GradeAPI: approveGrade(gradeId, comments)
    activate GradeAPI
    
    GradeAPI -> API: POST /grades/bcn/{gradeId}/review\n{decision: "approved", comments}
    activate API
    
    API -> DB: Update grade:\n- status = "approved"\n- bcnApprover, bcnApprovedAt\n- bcnComments
    activate DB
    DB -> API: updated grade
    deactivate DB
    
    API -> NotifSvc: Notify supervisor
    activate NotifSvc
    NotifSvc -> NotifSvc: createNotification(Lecturer, "grade-approved")
    deactivate NotifSvc
    
    API -> NotifSvc: Notify student
    activate NotifSvc
    NotifSvc -> NotifSvc: createNotification(Student, "grade-approved")
    deactivate NotifSvc
    
    API -> GradeAPI: {success: true}
    deactivate API
    
    GradeAPI -> DetailUI: success
    deactivate GradeAPI
    
    DetailUI -> BCN: Toast "Duyệt điểm thành công!"
    DetailUI -> BCN: Navigate back to list
    deactivate DetailUI
    
else Quyết định từ chối
    BCN -> DetailUI: Click "Từ chối"
    BCN -> DetailUI: Nhập lý do từ chối (required)
    BCN -> DetailUI: Confirm rejection
    
    DetailUI -> GradeAPI: rejectGrade(gradeId, reason)
    activate GradeAPI
    
    GradeAPI -> API: POST /grades/bcn/{gradeId}/review\n{decision: "rejected", reason}
    activate API
    
    API -> DB: Update grade:\n- status = "rejected"\n- bcnRejectionReason\n- Reset for re-submission
    activate DB
    DB -> API: updated grade
    deactivate DB
    
    API -> NotifSvc: Notify supervisor with reason
    activate NotifSvc
    NotifSvc -> NotifSvc: createNotification(Lecturer, "grade-rejected")
    deactivate NotifSvc
    
    API -> NotifSvc: Notify student
    activate NotifSvc
    NotifSvc -> NotifSvc: createNotification(Student, "grade-rejected")
    deactivate NotifSvc
    
    API -> GradeAPI: {success: true}
    deactivate API
    
    GradeAPI -> DetailUI: success
    deactivate GradeAPI
    
    DetailUI -> BCN: Toast "Từ chối thành công!"
    DetailUI -> BCN: Navigate back to list
    deactivate DetailUI
end

@enduml