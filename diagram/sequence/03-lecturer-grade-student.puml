@startuml Sequence - Giảng viên chấm điểm sinh viên

skinparam participantPadding 20
skinparam boxPadding 10

actor "Giảng viên" as Lecturer
participant "Grade Management UI" as GradeUI
participant "Grade Detail UI" as DetailUI
participant "Grade API" as GradeAPI
participant "API Server" as API
participant "Database" as DB
participant "Notification Service" as NotifSvc

Lecturer -> GradeUI: Truy cập /grade-management
activate GradeUI

GradeUI -> GradeAPI: getSupervisorGrades(statusFilter)
activate GradeAPI

GradeAPI -> API: GET /grades/supervisor/students
activate API

API -> DB: Find students by supervisor
activate DB
DB -> API: grades[]
deactivate DB

API -> GradeAPI: {grades: []}
deactivate API

GradeAPI -> GradeUI: grades data
deactivate GradeAPI

GradeUI -> Lecturer: Hiển thị danh sách sinh viên\n(status chips, search, pagination)

Lecturer -> GradeUI: Search/filter sinh viên
GradeUI -> GradeUI: Filter by query + workType

Lecturer -> GradeUI: Click vào sinh viên cần chấm điểm

GradeUI -> DetailUI: Navigate to /grade-management/{studentId}
activate DetailUI
deactivate GradeUI

DetailUI -> GradeAPI: getStudentGrade(studentId)
activate GradeAPI

GradeAPI -> API: GET /grades/students/{studentId}
activate API

API -> DB: Find grade by studentId + supervisor
activate DB
DB -> API: grade details with milestones
deactivate DB

API -> GradeAPI: grade data
deactivate API

GradeAPI -> DetailUI: detailed grade
deactivate GradeAPI

DetailUI -> Lecturer: Hiển thị form chấm điểm:\n- Grade components (attitude, report, practice)\n- Milestones\n- Final comment field

Lecturer -> DetailUI: Nhập điểm từng thành phần (0-10)
DetailUI -> DetailUI: Real-time validation\nCalculate final grade

Lecturer -> DetailUI: Nhập nhận xét cuối cùng
Lecturer -> DetailUI: Click "Nộp điểm"

DetailUI -> DetailUI: Validate:\n- All components graded\n- Final comment exists

alt Validation thành công
    DetailUI -> GradeAPI: submitGrade(studentId, gradeData)
    activate GradeAPI
    
    GradeAPI -> API: POST /grades/students/{studentId}/submit
    activate API
    
    API -> DB: Update grade:\n- components, finalGrade\n- status = "submitted"\n- submittedAt = now
    activate DB
    DB -> API: updated grade
    deactivate DB
    
    API -> NotifSvc: Notify BCN for approval
    activate NotifSvc
    NotifSvc -> NotifSvc: createNotification(BCN, "grade-submitted")
    deactivate NotifSvc
    
    API -> NotifSvc: Notify student about new grade
    activate NotifSvc
    NotifSvc -> NotifSvc: createNotification(Student, "grade-updated")
    deactivate NotifSvc
    
    API -> GradeAPI: {success: true}
    deactivate API
    
    GradeAPI -> DetailUI: success
    deactivate GradeAPI
    
    DetailUI -> Lecturer: Toast "Nộp điểm thành công!"
    DetailUI -> DetailUI: Disable form\nShow "Đã nộp" status
    deactivate DetailUI
    
else Validation thất bại
    DetailUI -> Lecturer: Hiển thị lỗi:\n- "Cần nhập nhận xét"\n- "Điểm không hợp lệ"
    deactivate DetailUI
end

@enduml