# QLTT - Internship Management System

## Architecture Overview

This is a **full-stack monorepo** for managing internship programs in educational institutions with 4 distinct roles:
- **PDT** (Phòng Đào Tạo / Training Department) - System administrators
- **BCN** (Ban Chủ Nhiệm / Department Head) - Subject managers  
- **GV** (Giảng Viên / Lecturer) - Supervisors
- **SV** (Sinh Viên / Student) - Participants

**Tech Stack:**
- Backend: Node.js/Express + MongoDB (Mongoose) + Socket.IO
- Frontend: React 19 + TypeScript + Vite + TailwindCSS
- Runtime: Bun (preferred for package management and execution)

## Critical Workflows

### Development Startup
**Always** use `bun run bun_script` to start both servers concurrently:
- Frontend: Vite dev server on port **5173** (strict port enforcement)
- Backend: Express + Socket.IO on port **3001**

The `bun_script.js` handles port conflicts intelligently by killing processes on 5173 before starting. Prefers Node.js for Vite to satisfy engine checks (>=20.19 or >=22.12).

### Database Connection
MongoDB connection string uses database name `QLTT` explicitly:
```javascript
mongoose.connect(process.env.MONGODB_URI || "mongodb://localhost:27017/QLTT", { dbName: 'QLTT' })
```

## Role-Based Access Control (RBAC)

### Role Values (kebab-case)
```typescript
type Role = "phong-dao-tao" | "ban-chu-nhiem" | "giang-vien" | "sinh-vien"
```

### Auth Middleware Patterns
- `authPDT`, `authBCN`, `authGV`, `authSV` - single role
- `authPDTOrBCN`, `authAll` - multi-role
- `authBCNForSubject` - validates BCN manages specific internship subject

Example route protection:
```javascript
router.get("/managed-students", authGV, async (req, res) => {
  // req.account contains authenticated user
});
```

### Frontend Route Guards
Routes are conditionally rendered in `App.tsx` based on `user?.role`. No shared routes except `/dashboard` and `/chat`.

## Data Model Conventions

### Auto-Generated IDs
All entities use custom string IDs auto-generated by Mongoose `pre('validate')` hooks:
- **Accounts**: `PDT001`, `BCN002`, `GV0001`, `SV0001` (role prefix + sequence)
- **InternshipSubjects**: `TT2025001` (TT + year + sequence)

**Never manually set IDs in client code** - let backend generate them.

### Key Models
```
Account → BanChuNhiem/GiangVien/SinhVien (profile extensions)
InternshipSubject → students[], lecturers[] (Account refs)
SinhVien → supervisor (Account ref), internshipSubject (InternshipSubject ref)
PageHeader → SubHeader[] (content structure)
```

### Status Fields
- Account: `"open" | "locked"`
- InternshipSubject: `"open" | "locked"` + virtual `registrationStatus`
- Student Internship Status: `"duoc-huong-dan" | "chua-duoc-huong-dan" | "dang-lam-do-an" | "dang-thuc-tap" | "hoan-thanh"`

## Real-Time Communication

### Socket.IO Integration
Server: `server/server.js` initializes Socket.IO and makes `io` available via `app.set('io', io)`

Frontend: `web/src/services/socketManager.ts` manages singleton connection

**Key Socket Events:**
- `authenticate` - join user-specific rooms: `user_{id}`, `role_{role}`
- `joinConversation` / `leaveConversation` - chat room management
- `newMessage`, `newNotification` - server-to-client broadcasts
- `typing`, `stopTyping` - typing indicators

**Access io in routes:**
```javascript
const io = req.app.get('io');
io.to(userId).emit('newNotification', notification);
```

## Frontend Service Layer

### API Client Pattern (`web/src/utils/api.ts`)
Centralized `apiClient` with typed methods:
- Automatic credentials inclusion (`credentials: "include"`)
- JWT tokens stored in httpOnly cookies (no localStorage)
- FormData detection for file uploads (no manual Content-Type)

```typescript
apiClient.login(email, password) // Returns LoginResponse
apiClient.getAccounts({ page, limit, status, role, search })
apiClient.createInternshipSubject(data)
```

### File Uploads
Backend serves uploads via:
```javascript
app.use("/uploads", express.static(uploadsDir, {
  setHeaders: (res) => res.setHeader("Cross-Origin-Resource-Policy", "cross-origin")
}));
```

Frontend references: `http://localhost:3001/uploads/{path}`

## Background Services

### Deadline Reminder Service
`server/services/deadlineReminderService.js` runs daily cron job (9:00 AM):
- Checks SubHeaders with `kind: 'nop-file'` and `endAt` within 3 days
- Sends notifications to students who haven't submitted
- Uses `notificationService` + Socket.IO for real-time alerts

### Notification System
`server/services/notificationService.js` provides unified notification creation:
```javascript
notificationService.createNotification({
  recipient: userId,
  type: 'deadline-reminder',
  title: '...',
  message: '...',
  link: '/docs-teacher/sub/123/upload',
  priority: 'urgent',
  metadata: { subHeaderId: '...' }
}, io);
```

**Notification Types:**
`chat-request | chat-message | request-accepted | request-rejected | report-reviewed | student-assigned | file-submitted | deadline-reminder | system | other`

## Page Management System

Two parallel content systems:
1. **Khoa Pages** - Department-wide content (managed by BCN)
2. **Teacher Pages** - Instructor-specific content (managed by GV)

**Structure:** `PageHeader → SubHeader[]`

**SubHeader Kinds:**
- `van-ban` (text content)
- `nop-file` (file submission with deadlines - `startAt`, `endAt`)
- `duong-dan` (external link)

**Audience:** `"public" | "students" | "lecturers"`

## Common Patterns

### Password Handling
Accounts support both bcrypt-hashed and legacy plaintext passwords (auto-migrates on login):
```javascript
AccountSchema.methods.comparePassword = async function(candidatePassword) {
  if (this.password.startsWith('$2a$') || this.password.startsWith('$2b$')) {
    return bcrypt.compare(candidatePassword, this.password);
  } else {
    // Legacy plaintext - compare and hash
    const isMatch = candidatePassword === this.password;
    if (isMatch) {
      this.password = candidatePassword; // Triggers pre-save hook
      await this.save();
    }
    return isMatch;
  }
};
```

### Error Handling
Backend returns Vietnamese error messages:
```javascript
res.status(400).json({ error: "Email không hợp lệ" });
```

Frontend displays errors from `response.error` or generic fallback.

### Code Style
- **Minimal comments** - code should be self-documenting
- **Vietnamese strings** for user-facing messages
- **Consistent naming:** kebab-case for roles/types, camelCase for JS/TS
- Remove obsolete comments when refactoring

## Testing & Validation

After changes, **always**:
1. Check for TypeScript/ESLint errors
2. Run `bun run bun_script` to verify both servers start
3. Test role-specific routes in browser

## Environment Variables

```env
# Backend (.env in server/)
MONGODB_URI=mongodb://localhost:27017/QLTT
JWT_SECRET=your-secret-key
CLIENT_URL=http://localhost:5173
PORT=3001
NODE_ENV=development

# Frontend (.env in web/)
VITE_API_URL=http://localhost:3001/api
```

## Key Files Reference

- `server/server.js` - Main entry point, Socket.IO setup, route registration
- `server/middleware/auth.js` - Auth middleware, role guards
- `web/src/App.tsx` - Route definitions, role-based rendering
- `web/src/utils/api.ts` - API client, type definitions
- `web/src/contexts/AuthContext.tsx` - Auth state management
- `bun_script.js` - Concurrent dev server orchestration
